#!/usr/bin/env bash

set -eo pipefail

indent() {
    echo "       $@"
}

puts-step() {
    echo "-----> $@"
}

puts-warn() {
    echo " !     $@"
}

puts-error() {
    echo " !!!   $@"
}

usage() {
    echo "Usage: $0 <user> <repo> <sha>"
}

ARGS=4

if [[ "$#" -ne "$ARGS" ]]; then
    usage
    exit 1
fi

# need to explicitly source /etc/environment due to https://github.com/docker/docker/issues/25388
source /etc/environment

REPO=$1
GIT_SHA=$2
SHORT_SHA=${GIT_SHA:0:8}
USER=$3
FINGERPRINT=$4

APP_NAME="${REPO%.*}"

cd $(dirname $0)/.. # ensure we are in the root dir

ROOT_DIR=$(pwd)
REPO_DIR="${ROOT_DIR}/${REPO}"
BUILD_DIR="${REPO_DIR}/build"
CACHE_DIR="${REPO_DIR}/cache"

mkdir -p $BUILD_DIR
mkdir -p $CACHE_DIR

# create temporary directory inside the build dir for this push
TMP_DIR=$(mktemp -d -p $BUILD_DIR)

cd $REPO_DIR
git archive $GIT_SHA | tar -xmC $TMP_DIR

# switch to app context
cd $TMP_DIR

if [ ! -f Dockerfile ]; then
    puts-error "No Dockerfile found in root dir. Exiting."
    exit 1
fi

# define image name
IMAGE_NAME="$APP_NAME:git-$SHORT_SHA"
TMP_IMAGE="localhost:5000/$IMAGE_NAME"

puts-step "Building Docker image"
docker build -t $TMP_IMAGE .

puts-step "Pushing image to registry"
docker push $TMP_IMAGE

puts-step "Launching..."
helm install /usr/local/share/chart.shim --namespace $APP_NAME --set name="$APP_NAME",version="git-$SHORT_SHA",registry="$DEIS3_SERVICE_HOST:$DEIS3_SERVICE_PORT_REGISTRY"
indent "done, $IMAGE_NAME deployed to Kubernetes"

# cleanup
cd $REPO_DIR
git gc &>/dev/null
rm -rf $TMP_DIR
